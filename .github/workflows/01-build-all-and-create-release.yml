name: 01 - ðŸš€ Build All and Create Release

on:
  workflow_dispatch:

jobs:
  call-windows-build:
    name: ðŸ¢ Build on Windows
    strategy:
      matrix:
        file: [
          'toolbox/heic-heif-converter/heic-heif-converter.py',
          'toolbox/archive-manifest-file-tool/mnftool_gui.py',
          'toolbox/file-copy-tool/filecopy_tool.py',
          'toolbox/folder-stats-tool/folderstats.py',
          'toolbox/garmin-gps-file-converter/gpxconverter.py'
        ]

    uses: ./.github/workflows/reusable-windows-build.yml
    with:
      file: ${{ matrix.file }}

  call-macos-build:
    name: ðŸ Build on macOS
    strategy:
      matrix:
        file: [
          'toolbox/heic-heif-converter/heic-heif-converter.py',
          'toolbox/archive-manifest-file-tool/mnftool_gui.py',
          'toolbox/file-copy-tool/filecopy_tool.py',
          'toolbox/folder-stats-tool/folderstats.py',
          'toolbox/garmin-gps-file-converter/gpxconverter.py'
        ]

    uses: ./.github/workflows/reusable-macos-build.yml
    with:
      file: ${{ matrix.file }}

  call-linux-build:
    name: ðŸ§ Build on Linux
    strategy:
      matrix:
        file: [
          'toolbox/heic-heif-converter/heic-heif-converter.py',
          'toolbox/archive-manifest-file-tool/mnftool_gui.py',
          'toolbox/file-copy-tool/filecopy_tool.py',
          'toolbox/folder-stats-tool/folderstats.py',
          'toolbox/garmin-gps-file-converter/gpxconverter.py'
        ]

    uses: ./.github/workflows/reusable-linux-build.yml
    with:
      file: ${{ matrix.file }}

  create-release:
    name: ðŸ·ï¸ Create Release
    needs: [call-windows-build, call-macos-build, call-linux-build]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set release name and tag
      id: set-release
      run: |
        DATE_TIME=$(date +%Y%m%d_%H-%M-%S)
        echo "RELEASE_TAG=v1.0.${DATE_TIME}" >> $GITHUB_ENV
        echo "RELEASE_NAME=Release v1.0.${DATE_TIME}" >> $GITHUB_ENV

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: |
          ${{ needs.call-windows-build.outputs.artifact_name }}
        path: ./artifacts/

    - name: List downloaded artifacts
      run: ls -R ./artifacts

    - name: Create and Upload Release
      uses: ncipollo/release-action@v1
      with:
        artifacts: './artifacts/**/*.zip'
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: ${{ env.RELEASE_TAG }}
        name: ${{ env.RELEASE_NAME }}
        body: |
          ### Release ${{ env.RELEASE_NAME }}
          This release includes the following builds:
          - Windows
          - macOS
          - Linux
        draft: true
        prerelease: true